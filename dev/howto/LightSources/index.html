<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Creating light sources · Virtual Plant Laboratory</title><meta name="title" content="Creating light sources · Virtual Plant Laboratory"/><meta property="og:title" content="Creating light sources · Virtual Plant Laboratory"/><meta property="twitter:title" content="Creating light sources · Virtual Plant Laboratory"/><meta name="description" content="Documentation for Virtual Plant Laboratory."/><meta property="og:description" content="Documentation for Virtual Plant Laboratory."/><meta property="twitter:description" content="Documentation for Virtual Plant Laboratory."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Virtual Plant Laboratory</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Virtual Plant Laboratory</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">Julia</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../manual/Julia/Julia/">Julia basic concepts</a></li><li><a class="tocitem" href="../../manual/Julia/Objects/">Multiple dispatch and composition</a></li><li><a class="tocitem" href="../../manual/Julia/Modules/">Modules and files</a></li></ul></li><li><a class="tocitem" href="../../manual/Graphs/">Dynamic graph creation and manipulation</a></li><li><a class="tocitem" href="../../manual/Geometry/Primitives/">Geometry primitives</a></li><li><a class="tocitem" href="../../manual/Geometry/Turtle/">Turtle geometry and scenes</a></li><li><a class="tocitem" href="../../manual/Raytracer/">Ray tracing</a></li><li><a class="tocitem" href="../../manual/Visualization/">3D visualization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/intro_tut/">Intro</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Getting started with VPL</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/getting_started/algae/">Algae growth</a></li><li><a class="tocitem" href="../../tutorials/getting_started/snowflakes/">The Koch snowflake</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">From tree to forest</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/from_tree_forest/tree/">Tree</a></li><li><a class="tocitem" href="../../tutorials/from_tree_forest/forest/">Forest</a></li><li><a class="tocitem" href="../../tutorials/from_tree_forest/growthforest/">Growth forest</a></li><li><a class="tocitem" href="../../tutorials/from_tree_forest/raytracedforest/">Ray-traced forest</a></li><li><a class="tocitem" href="../../tutorials/from_tree_forest/photosynthesis/">Canopy photosynthesis</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">More on rules and queries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/more_rules_queries/context/">Context sensitive rules</a></li><li><a class="tocitem" href="../../tutorials/more_rules_queries/relationalqueries/">Relational queries</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../GridCloner/">Setting up a grid cloner</a></li><li><a class="tocitem" href="../Message/">Messages in scenes</a></li><li><a class="tocitem" href="../Materials/">Multiple materials/colors</a></li><li><a class="tocitem" href="../Traversal/">Advanced traversal</a></li><li><a class="tocitem" href="../Coordinates/">Absolute coordinates</a></li><li class="is-active"><a class="tocitem" href>Creating light sources</a><ul class="internal"><li><a class="tocitem" href="#What-makes-a-light-source?"><span>What makes a light source?</span></a></li><li><a class="tocitem" href="#Creating-your-own-direction-component-of-a-light-source"><span>Creating your own direction component of a light source</span></a></li><li><a class="tocitem" href="#Example:-Gaussian-light-source"><span>Example: Gaussian light source</span></a></li></ul></li><li><a class="tocitem" href="../Slicer/">Using the slicer</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/graphs/">Graphs</a></li><li><a class="tocitem" href="../../api/geometry/">Scenes and 3D meshes</a></li><li><a class="tocitem" href="../../api/turtle/">Turtle geometry</a></li><li><a class="tocitem" href="../../api/raytracer/">Ray tracing</a></li><li><a class="tocitem" href="../../api/viz/">3D visualization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">VPLVerse</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-6-1" type="checkbox"/><label class="tocitem" for="menuitem-6-1"><span class="docs-label">SkyDomes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../VPLVerse/SkyDomes/">SkyDomes package</a></li><li><a class="tocitem" href="../../VPLVerse/SkyDomes/API/">SkyDomes API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-2" type="checkbox"/><label class="tocitem" for="menuitem-6-2"><span class="docs-label">Ecophys</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../VPLVerse/Ecophys/">Ecophys package</a></li><li><a class="tocitem" href="../../VPLVerse/Ecophys/photosynthesis/">Photosynthesis API</a></li><li><a class="tocitem" href="../../VPLVerse/Ecophys/growth/">Growth API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-3" type="checkbox"/><label class="tocitem" for="menuitem-6-3"><span class="docs-label">PlantSimEngine</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../VPLVerse/PlantSimEngine/">PlantSimEngine package</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-4" type="checkbox"/><label class="tocitem" for="menuitem-6-4"><span class="docs-label">PlantBioPhysics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../VPLVerse/PlantBioPhysics/">PlantBioPhysics package</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../developers/organization/">Internal organization</a></li><li><a class="tocitem" href="../../developers/use&amp;dev_packages/">Package and Environment Management for VPL</a></li><li><a class="tocitem" href="../../developers/style/">Styling protocol</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How-to guides</a></li><li class="is-active"><a href>Creating light sources</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Creating light sources</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/VirtualPlantLab/VPLDocs/blob/master/docs/src/howto/LightSources.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p><strong>Redo tutorial using a tiled floor, we should be able to see spatial distribution better</strong></p><h1 id="Constructing-light-sources"><a class="docs-heading-anchor" href="#Constructing-light-sources">Constructing light sources</a><a id="Constructing-light-sources-1"></a><a class="docs-heading-anchor-permalink" href="#Constructing-light-sources" title="Permalink"></a></h1><p>Alejandro Morales</p><p>Centre for Crop Systems Analysis - Wageningen University</p><h2 id="What-makes-a-light-source?"><a class="docs-heading-anchor" href="#What-makes-a-light-source?">What makes a light source?</a><a id="What-makes-a-light-source?-1"></a><a class="docs-heading-anchor-permalink" href="#What-makes-a-light-source?" title="Permalink"></a></h2><p>In VPL, a light (or radiation) source is responsible for generating rays that will be traced throughout a 3D scene as they interact with surfaces. A ray is composed of three components: a direction, an origin, and a vector of radiant power.</p><p>Both the origin and the direction of a ray are generated randomly by the light source according to specific distributions, whereas the radiant power per ray and the total number of rays is determined by the user during the simulation. Therefore, defining a new type of light source consists of defining the distributions for the origin and direction of the rays.</p><p>The origin of the rain is determined by the geometry component of a light source (field <code>geom</code> of the type <code>Source</code>). VPL currently supports the following geometry components:</p><ul><li><p><code>PointSource</code>: A single point in space from which all rays are generated.</p></li><li><p><code>LineSource</code>: A line segment in space from which all rays are sampled randomly.</p></li><li><p><code>AreaSource</code>: A 3D mesh representing a surface from which all rays are sampled randomly.</p></li><li><p><code>DirectionalSource</code>: A special case for directional light sources that should cover the entire scene (assuming one is using a grid cloner).</p></li></ul><p>The direction of the rays is determined by the direction component of a light source (field <code>angle</code> of the type <code>Source</code>). VPL currently implements two types of direction components:</p><ul><li><p><code>FixedSource</code>: All rays have the same direction (generally combined with <code>DirectionalSource</code> to represent solar radiation).</p></li><li><p><code>LambertianSource</code>: The direction of the rays is sampled from a Lambertian distribution.</p></li></ul><p>Users may want to defined their own light sources, often by specifying different distributions of directions to the ones provided by VPL in order to capture more realistic the light sources used in certain productive contexts (e.g., greenhouses and vertical farms). This guide illustrates how to define a new light source in VPL by specifying the direction component assuming a Gaussian distribution.</p><h2 id="Creating-your-own-direction-component-of-a-light-source"><a class="docs-heading-anchor" href="#Creating-your-own-direction-component-of-a-light-source">Creating your own direction component of a light source</a><a id="Creating-your-own-direction-component-of-a-light-source-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-your-own-direction-component-of-a-light-source" title="Permalink"></a></h2><p>Creating a new direction component in VPL is straightforward. The user needs to define a new type that inherits from the abstract class <code>SourceAngle</code> and defined a method for the function <code>generate_direction</code> that takes as first argument the user-defined type and as second a random number generator. The method should return a 3D unit vector representing the direction of the ray. The user is given complete freedom as to how the direction is generated.</p><p>Typically, the distribution of possible distributions is encoded in polar coordinates, that is, the azimuth (<span>$Phi$</span>, orientation of the ray) and zenith angles (<span>$theta$</span>, inclination of the ray) with respect to the plane that contains the light source. This requires defining a local coordinate system for the light source, that is, an XYZ coordinate system where the XY plane is the plane that contains the light source and the Z axis is perpendicular to the plane.</p><p>Given the azimuth and zenith angles and the local coordinate system, the direction of the ray can be computed using the <code>polar_to_cartesian</code> function provided by the package PlantRayTracer within VPL.</p><p>The function <code>polar_to_cartesian</code> will perform the necessary conversions and ensure that the resulting direction vector meets the expectations of the ray tracer within VPL. The user thus only needs to specify distributions for the azimuth and zenith angles and generate the samples accordingly. Let&#39;s illustrate this with a Gaussian light source.</p><h2 id="Example:-Gaussian-light-source"><a class="docs-heading-anchor" href="#Example:-Gaussian-light-source">Example: Gaussian light source</a><a id="Example:-Gaussian-light-source-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Gaussian-light-source" title="Permalink"></a></h2><p>A Gaussian light source is a light source where the azimuth angle follows an uniform distribution (from 0 to 2π radians) and the zenith angle follows a Gaussian distribution constrained within the interval [-π/2, π/2] radians centered at 0. This Gaussian distribution will be parameterized by a standard deviation <span>$\sigma$</span>. First we define the type for the Gaussian light source to store the axes of the local coordinate system and the standard deviation of the zenith angle.</p><pre><code class="language-julia hljs">using VirtualPlantLab
import PlantRayTracer as PRT
struct GaussianSource &lt;: PRT.SourceAngle
    x::Vec{Float64}
    y::Vec{Float64}
    z::Vec{Float64}
    σ::Float64
end</code></pre><p>We will then use the Distributions.jl package to generate the samples for the zenith angle by defining a method to the function <code>generate_direction</code>:</p><pre><code class="language-julia hljs">using Distributions
import ColorTypes: RGB
function PRT.generate_direction(source::GaussianSource, rng)
    dist = Truncated(Normal(0, source.σ), -π/2, π/2)
    θ    = rand(rng, dist)
    Φ    = 2π*rand(rng)
    dir  = PRT.polar_to_cartesian((e1 = source.x, e2 = source.y, n = source.z), θ, Φ)
    return dir
end</code></pre><p>We also need to define the geometry of the light source. Let&#39;s assume that the light source is just a point in space at coordinates [0.5, 0.5, 1.0], that it is pointing downwards, the radiant power is 1 and we want to generate one million rays. We create the light source as follows:</p><pre><code class="language-julia hljs">source = Source(PointSource(Vec(0.5, 0.5, 1.0)), GaussianSource(X(), Y(), -Z(), 0.1), 1.0, 1_000_000)</code></pre><p>This light source is rather narrow as we use a standar deviation of 0.1. We can visualize the distribution of zenith angles as follows:</p><pre><code class="language-julia hljs">using Plots
dist = Truncated(Normal(0, 0.1), -π/2, π/2)
θ = rand(dist, 1_000_000)
histogram(θ, label = &quot;&quot;, xlabel = &quot;Zenith angle&quot;, ylabel = &quot;Prob. density&quot;, normalize=:pdf)
vline!([-π/2, π/2], label = &quot;&quot;)</code></pre><p>The light source is now ready to be used in a ray tracer. We will test this light source by creating multiple sensors below the light source and measuring the light intensity at each sensor.</p><pre><code class="language-julia hljs">mesh = Mesh()
sensors = [Sensor(1) for _ in 1:400]
c = 1
for i in 1:20
    for j in 1:20
        r = Rectangle(length = 0.05, width = 0.05)
        rotatey!(r, π/2) ## To put it in the XY plane
        VirtualPlantLab.translate!(r, Vec((i - 1)*0.05, (j - 1)*0.05 + 0.025, 0.0))
        add!(mesh, r, materials = sensors[c], colors = rand(RGB))
        c += 1
    end
end</code></pre><pre><code class="language-julia hljs">import GLMakie
render(mesh)</code></pre><p>We can now create a ray tracing object without a grid cloner (note that since all the surfaces are sensors we can just set <code>maxiter = 1</code>):</p><pre><code class="language-julia hljs">settings = RTSettings(pkill = 0.9, maxiter = 1, parallel = true)
rtobj = RayTracer(mesh, source, settings = settings);
trace!(rtobj)</code></pre><p>We can now visualize the results by plotting the light intensity at each sensor:</p><pre><code class="language-julia hljs">p_narrow = [power(s)[1]/1_000_000 for s in sensors]
coords = collect(0.025:0.05:0.975)
heatmap(coords, coords, reshape(p_narrow,20,20))</code></pre><p>We can see a straight line meaning that the light intensity is practical constant at each sensor since the light source is so narrow. Let&#39;s now test a wider light source by setting the standard deviation to 1.5. Let&#39;s first look at the histogram</p><pre><code class="language-julia hljs">dist = Truncated(Normal(0, 1.0), -π/2, π/2)
θ = rand(dist, 1_000_000)
histogram(θ, label = &quot;&quot;, xlabel = &quot;Zenith angle&quot;, ylabel = &quot;Prob. density&quot;, normalize=:pdf)
vline!([-π/2, π/2], label = &quot;&quot;)</code></pre><p>Now we expect a lot of rays to escaped from the sides of the scene and not hit the sensors. Let&#39;s test this by creating a new light source and tracing the rays again.</p><pre><code class="language-julia hljs">source = Source(PointSource(Vec(0.5, 0.5, 1.0)), GaussianSource(X(), Y(), -Z(), 1.0), 1.0, 1_000_000)
settings = RTSettings(pkill = 0.9, maxiter = 1, parallel = true)
rtobj = RayTracer(mesh, source, settings = settings);
trace!(rtobj)</code></pre><p>If we plot the light intensity at each sensor we will see that the sensors receive less light than before but also the gradient of light intensity towards the shaded regions is less pronounced.</p><pre><code class="language-julia hljs">p_wide = [power(s)[1]/1_000_000 for s in sensors]
heatmap(coords, coords, reshape(p_wide,20,20))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Coordinates/">« Absolute coordinates</a><a class="docs-footer-nextpage" href="../Slicer/">Using the slicer »</a><div class="flexbox-break"></div></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Thursday 4 September 2025 05:56">Thursday 4 September 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
