<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Setting up a grid cloner · Virtual Plant Laboratory</title><meta name="title" content="Setting up a grid cloner · Virtual Plant Laboratory"/><meta property="og:title" content="Setting up a grid cloner · Virtual Plant Laboratory"/><meta property="twitter:title" content="Setting up a grid cloner · Virtual Plant Laboratory"/><meta name="description" content="Documentation for Virtual Plant Laboratory."/><meta property="og:description" content="Documentation for Virtual Plant Laboratory."/><meta property="twitter:description" content="Documentation for Virtual Plant Laboratory."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Virtual Plant Laboratory</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Virtual Plant Laboratory</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../manual/Julia/">Julia basic concepts</a></li><li><a class="tocitem" href="../../manual/Graphs/">Dynamic graph creation and manipulation</a></li><li><a class="tocitem" href="../../manual/Geometry/Primitives/">Geometry primitives</a></li><li><a class="tocitem" href="../../manual/Geometry/Turtle/">Turtle geometry and scenes</a></li><li><a class="tocitem" href="../../manual/Raytracer/">Ray tracing</a></li><li><a class="tocitem" href="../../manual/Visualization/">3D visualization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/intro_tut/">Intro</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Getting started with VPL</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/getting_started/algae/">Algae growth</a></li><li><a class="tocitem" href="../../tutorials/getting_started/snowflakes/">The Koch snowflake</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">From tree to forest</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/from_tree_forest/tree/">Tree</a></li><li><a class="tocitem" href="../../tutorials/from_tree_forest/forest/">Forest</a></li><li><a class="tocitem" href="../../tutorials/from_tree_forest/growthforest/">Growth forest</a></li><li><a class="tocitem" href="../../tutorials/from_tree_forest/raytracedforest/">Ray-traced forest</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">More on rules and queries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/more_rules_queries/context/">Context sensitive rules</a></li><li><a class="tocitem" href="../../tutorials/more_rules_queries/relationalqueries/">Relational queries</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Setting up a grid cloner</a><ul class="internal"><li><a class="tocitem" href="#Example"><span>Example</span></a></li></ul></li><li><a class="tocitem" href="../Message/">Messages in scenes</a></li><li><a class="tocitem" href="../Materials/">Multiple materials/colors</a></li><li><a class="tocitem" href="../Traversal/">Advanced traversal</a></li><li><a class="tocitem" href="../Coordinates/">Absolute coordinates</a></li><li><a class="tocitem" href="../LightSources/">Creating light sources</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/graphs/">Graphs</a></li><li><a class="tocitem" href="../../api/geometry/">Scenes and 3D meshes</a></li><li><a class="tocitem" href="../../api/turtle/">Turtle geometry</a></li><li><a class="tocitem" href="../../api/raytracer/">Ray tracing</a></li><li><a class="tocitem" href="../../api/viz/">3D visualization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">VPLVerse</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-6-1" type="checkbox"/><label class="tocitem" for="menuitem-6-1"><span class="docs-label">SkyDomes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../VPLVerse/SkyDomes/">SkyDomes package</a></li><li><a class="tocitem" href="../../VPLVerse/SkyDomes/API/">SkyDomes API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-2" type="checkbox"/><label class="tocitem" for="menuitem-6-2"><span class="docs-label">Ecophys</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../VPLVerse/Ecophys/">Ecophys package</a></li><li><a class="tocitem" href="../../VPLVerse/Ecophys/photosynthesis/">Photosynthesis API</a></li><li><a class="tocitem" href="../../VPLVerse/Ecophys/growth/">Growth API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-3" type="checkbox"/><label class="tocitem" for="menuitem-6-3"><span class="docs-label">PlantSimEngine</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../VPLVerse/PlantSimEngine/">PlantSimEngine package</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-4" type="checkbox"/><label class="tocitem" for="menuitem-6-4"><span class="docs-label">PlantBioPhysics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../VPLVerse/PlantBioPhysics/">PlantBioPhysics package</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../developers/organization/">Internal organization</a></li><li><a class="tocitem" href="../../developers/use&amp;dev_packages/">Package and Environment Management for VPL</a></li><li><a class="tocitem" href="../../developers/style/">Styling protocol</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How-to guides</a></li><li class="is-active"><a href>Setting up a grid cloner</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Setting up a grid cloner</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/VirtualPlantLab/VPLDocs/blob/master/docs/src/howto/GridCloner.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="How-to-setup-a-grid-cloner"><a class="docs-heading-anchor" href="#How-to-setup-a-grid-cloner">How to setup a grid cloner</a><a id="How-to-setup-a-grid-cloner-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-setup-a-grid-cloner" title="Permalink"></a></h1><p>In many FSP models, users want to simulate a large field of plants, but it is not computationally feasible to do so. Instead, a reduced number of representative plants in a plot are simulated. However, this can introduce border effects when simulating plant-environment interactions (for example when computing light interception). The goal of the grid cloner is to reduce this border effect when computing light interception by cloning the entire 3D scene along the different axes by a distance specified by the user (in each direction).</p><p>The grid cloner is implemented using <em>object instancing</em> from ray tracing. This approach will affect the position of the ray as if it was intersecting a cloned scene adjacent to the original one, thus still reusing the original mesh. For example, if the scene is replicated along the x-axis at a distance of 1, the ray will be translated a distance of -1 along the x-axis to check for intersections with that clone. Thus, no extra memory is required to store the clones.</p><p>Conceptually, this grid cloner is similar to using <em>periodic boundaries</em> on the sides of the bounding box of the scene. The main differences are that (i) the grid cloner only allows a finite number of clones (periodic boundaries could be, in theory, infinite) and (ii) the bounding boxes of clones may overlap. The latter feature accounts for the fact that the root and shoot systems of plants may <em>overlap</em> in the field.</p><p>In the most common scenario, the user is simulating a field of plants with a regular spacing between plants (e.g., defined by distance between rows and within rows). In this case, the recommended way to create the grid cloner is as follows:</p><ul><li><p>The clones should be created at multiples of these distances.</p></li><li><p>The rows should be aligned with the x- or y-axis.</p></li><li><p>Soil and sensor tiles should not extend more than half the distance between or within rows along each axis.</p></li></ul><p>In this canonical setup, the clones will overlap if the shoot or root systems of the border plants extend beyond the midpoint between or within rows, but the soil/sensor tiles will not overlap. The latter is important as otherwise calculations of light interception by such tiles will be incorrect.</p><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>Load the dependencies</p><pre><code class="language-julia hljs">using VirtualPlantLab
import ColorTypes: RGB
import GLMakie</code></pre><p>A plant will be represented by a simple cylinder located at different points in a grid. We create the grid given the recommendations in the above. Using this template ensures that the scene has the proper dimensions while still scaling with the number of plants and rows:</p><pre><code class="language-julia hljs">dx = 2.0
dy = 0.5
nrows = 10
nplants = 10
origins = [Vec(i,j,0) for i = dx/2:dx:(nrows - 0.5)dx, j = dy/2:dy:(nplants - 0.5)dy];</code></pre><p>We create a simple plant placeholder defined by a stem and a single long leaf:</p><pre><code class="language-julia hljs">struct Plant &lt;: Node end
function VirtualPlantLab.feed!(turtle::Turtle, plant::Plant, data)
    HollowCylinder!(turtle, move = true, colors = RGB(0.63, 0.63, 0.63), length = 2.0,
                    width = 0.25, height = 0.25)
    rh!(turtle, rand()*360.0)
    ra!(turtle, rand()*90.0)
    Rectangle!(turtle, colors = RGB(0.0, 1.0, 0.0), length = 3.0, width = 0.2)
    return nothing
end
axiom(origin) = T(origin) + Plant()
plants = [Graph(axiom = axiom(origin)) for origin in origins];</code></pre><p>We will also add several soil tiles to the scene. Each tile will correspond to a single plant and thus represent the spacing allocated to each plant given the planting pattern. We will not use a graph for these tiles but rather create them <em>manually</em> using available primitives and transformations (note how we shift the tile along the x axis to center it on the plant!):</p><pre><code class="language-julia hljs">function create_tile(p, dx, dy)
    tile = Rectangle(length = dx, width = dy)
    rotatey!(tile, pi/2)
    VirtualPlantLab.translate!(tile, p .+ Vec(-dx/2, 0.0, 0.0))
    return tile
end
tiles = vec([create_tile(origin, dx, dy) for origin in origins]);</code></pre><p>Now we can combine the plants and tiles into a single mesh. We randomize the color of each tile to help identify them in the visualization:</p><pre><code class="language-julia hljs">plant_mesh = Mesh(vec(plants));
soil_mesh = Mesh()
for tile in tiles
    add!(soil_mesh, tile, colors = RGB(rand(), rand(), rand()))
end
mesh = Mesh([plant_mesh, soil_mesh]);
render(mesh)</code></pre><p>We can also visualize the bounding boxes of a mesh (and any clone). If we just want the box for the original mesh, we can create a grid with no clones. The build the acceleration object (which includes the grid cloner) and add it to the 3D rendering:</p><pre><code class="language-julia hljs">rt_settings = RTSettings(nx = 0, ny = 0)
acc_one = accelerate(mesh, settings = rt_settings);
render(mesh)
render!(acc_one.grid)</code></pre><p>We can see that bounding box extends to the tips of the leaves, as they grow beyond the soil area allocated to the plant. If we now create multiple clones of this mesh, we should displace them by a distance of <code>10dx</code> along the x-axis and <code>10dy</code> along the y-axis. This will ensure that the soil tiles of clones do not overlap but the plants will. In other words, we emulate additional rows and plants within rows while respecting the same spacing between them:</p><pre><code class="language-julia hljs">rt_settings = RTSettings(nx = 1, ny = 1, dx = 10dx, dy = 10dy)
acc = accelerate(mesh, settings = rt_settings);</code></pre><p>We can now add all the bounding boxes of the clones to the mesh:</p><pre><code class="language-julia hljs">render(mesh)
render!(acc.grid)</code></pre><p>We can see that the bounding boxes of the clones overlap, as expected. Currently there is no way in VPL to visualize the actual clones (since that additional geometry is never actually generated, see details about <em>instancing</em> above). We can do this manually by manually changing the meshes of the mesh using the method <code>VirtualPlantLab.translate!</code>. We add the bounding box of the original mesh too:</p><pre><code class="language-julia hljs">meshes = Mesh[]
for i in -10:10
    for j in -10:10
        new_mesh = deepcopy(mesh)
        VirtualPlantLab.translate!(new_mesh, Vec(i*10dx, j*10dy, 0.0))
        push!(meshes, new_mesh)
    end
end
render(Mesh(meshes), axes = false)
render!(acc_one.grid, alpha = 0.8)</code></pre><p>Because of the random color scheme, we can visually check that the soil tiles do not overlap and that the distance within and between rows is respected across clones. Effectively, this is a visualization of what the ray tracer &quot;sees&quot; in the simulations. Effectively, each plant in the original scene is cloned multiple times and the absorbed power from all these clones is aggregated. However, the light sources are not being duplicated, those are still defined by the original scene (which is located in the center of the grid).</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../tutorials/more_rules_queries/relationalqueries/">« Relational queries</a><a class="docs-footer-nextpage" href="../Message/">Messages in scenes »</a><div class="flexbox-break"></div></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Tuesday 17 December 2024 11:21">Tuesday 17 December 2024</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
